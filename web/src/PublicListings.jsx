import { useEffect, useState } from 'react';
import { API } from './lib/api';
export default function PublicListings(){const[items,setItems]=useState([]);const[viewingFee,setViewingFee]=useState(0);const[refById,setRefById]=useState({});useEffect(()=>{(async()=>{try{const lst=await API.listings();setItems(lst.items||[]);setViewingFee(lst.viewingFeeZMW||0);}catch(e){alert(e.message);}})();},[]);const unlockWithReference=async(id)=>{try{const reference=(refById[id]||'').trim();if(!reference)return alert('Enter a reference first.');await API.paymentsSimulate({listingId:id,reference,channel:'manual'});await API.unlock(id);const lst=await API.listings();setItems(lst.items||[]);alert('Contact unlocked.');}catch(e){alert(e.message);}};return(<div style={{fontFamily:'system-ui, Arial',maxWidth:860,margin:'20px auto'}}><div style={{padding:12,background:'#f1f5f9',border:'1px solid #e2e8f0',borderRadius:8}}><b>Chilimba (Village Banking)</b><div>Save together, borrow fairly. Register groups early.</div><div style={{marginTop:8}}><button onClick={()=>alert('Chilimba is a rotating savings… Set rules, automate reminders.')}>What is Chilimba?</button><a href='https://wa.me/' target='_blank' rel='noreferrer' style={{marginLeft:8}}>WhatsApp Groups</a><a href='#/submit' style={{marginLeft:8}}>Post new listing</a><a href='#' onClick={async(e)=>{e.preventDefault();alert(await API.terms());}} style={{marginLeft:8}}>Disclaimer</a></div></div><div style={{marginTop:16}}>{items.map(it=>(<div key={it.id} style={{padding:12,border:'1px solid #e5e7eb',borderRadius:8,marginBottom:10}}><div style={{fontWeight:600}}>{it.title}</div><div style={{opacity:0.7}}>{it.location} • ZMW {it.priceZMW}</div>{it.contactHidden?(<><div style={{marginTop:6}}>Contact locked. Unlock for ZMW {viewingFee}.</div><div style={{marginTop:8,display:'flex',gap:8}}><input placeholder='Enter payment reference' value={refById[it.id]||''} onChange={(e)=>setRefById(s=>({...s,[it.id]:e.target.value}))}/><button onClick={()=>unlockWithReference(it.id)}>Unlock with reference</button><a href='https://wa.me/' target='_blank' rel='noreferrer'>Pay via WhatsApp (manual)</a></div></>):(<div style={{marginTop:6}}>Call: {it.contact?.phone}</div>)}</div>))}</div></div>);}
